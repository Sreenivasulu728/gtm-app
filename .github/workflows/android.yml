name: Build Android APK

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install Ubuntu dependencies
      run: |
        # OpenJDK 17 is required by the Android build tools
        sudo apt update
        sudo apt install "-y" python3-pip python3-setuptools git zip openjdk-17-jdk unzip wget libpython3-dev

    - name: Install Buildozer + Cython
      run: |
        # Install buildozer and cython to user path
        pip install --user buildozer cython
        # Add user's local bin to the PATH for subsequent steps
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Set up Environment Variables
      run: |
        # Ensure licenses are accepted automatically for all buildozer commands
        echo "ANDROID_SDK_ACCEPT_LICENSES=yes" >> $GITHUB_ENV
        # Set JAVA_HOME explicitly for the build process
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        # Set SDK root path if needed, though buildozer manages internally
        echo "ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV

    - name: Build APK (Automatic Dependencies)
      # Environment variables are already set via GITHUB_ENV in the previous step
      run: |
        # Buildozer will now automatically accept licenses when downloading SDK/NDK/ANT
        buildozer android debug
